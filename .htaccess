<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # 1. Route API and Sanctum requests to Laravel backend
    RewriteCond %{REQUEST_URI} ^/(api|sanctum)
    RewriteRule ^(.*)$ backend/public/index.php [L]

    # 2. Serve built frontend files from /dist/ if they exist
    # First, check if the file exists in the root (unlikely for built assets)
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ - [L]

    # If the file exists in /dist/, serve it
    RewriteCond %{DOCUMENT_ROOT}/dist/$1 -f
    RewriteRule ^(.*)$ dist/$1 [L]

    # 3. SPA Routing: Route everything else to dist/index.html
    # (Excluding files that already exist in backend/public if they are direct hits)
    RewriteCond %{REQUEST_URI} !^/backend/public
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ dist/index.html [L]
</IfModule>

# Security: Deny access to sensitive files
<FilesMatch "^\.env|composer\.json|composer\.lock|package\.json|package-lock\.json|tsconfig\.json|vite\.config\.ts">
    Order allow,deny
    Deny from all
</FilesMatch>

# Optimize: Enable compression if available
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>
